{% extends "base.html" %}

{% block title %}Currency Data - POE Market Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-coins text-warning"></i> 
            Currency Data
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table"></i> Currency Exchange Rates (Last 24 Hours)
            </div>
            <div class="card-body">
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading currency data...</p>
                </div>
                
                {% if currency_data %}
                <!-- Search Filter and Export Controls -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="currencySearch" placeholder="Search currencies..." onkeyup="applyAllFilters()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedFilters()">
                                <i class="fas fa-filter"></i> Advanced Filters
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="exportData('json')">
                                <i class="fas fa-file-code"></i> JSON
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">Found <span id="resultCount">{{ currency_data|length }}</span> currencies</small>
                    </div>
                </div>
                
                <!-- Advanced Filters Panel -->
                <div id="advancedFilters" class="card mb-3" style="display: none;">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Confidence Level</label>
                                <select class="form-select form-select-sm" id="confidenceFilter" onchange="applyAllFilters()">
                                    <option value="">All Confidence Levels</option>
                                    <option value="high">High Confidence</option>
                                    <option value="low">Low Confidence</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Chaos Value Range</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="chaosMin" placeholder="Min" onchange="applyAllFilters()">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="chaosMax" placeholder="Max" onchange="applyAllFilters()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Divine Value Range</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="divineMin" placeholder="Min" step="0.01" onchange="applyAllFilters()">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="divineMax" placeholder="Max" step="0.01" onchange="applyAllFilters()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAllFilters()">
                                        <i class="fas fa-times"></i> Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable" onclick="sortTable(0, 'string')" style="cursor: pointer;">
                                    Currency <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable" onclick="sortTable(1, 'number')" style="cursor: pointer;">
                                    Buy Price <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable" onclick="sortTable(2, 'number')" style="cursor: pointer;">
                                    Sell Price <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable" onclick="sortTable(3, 'number')" style="cursor: pointer;">
                                    Price Gap <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable" onclick="sortTable(4, 'number')" style="cursor: pointer;">
                                    Chaos Value <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable" onclick="sortTable(5, 'number')" style="cursor: pointer;">
                                    Market Depth <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable" onclick="sortTable(6, 'string')" style="cursor: pointer;">
                                    Confidence <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th>Pay Trend</th>
                                <th>Receive Trend</th>
                                <th class="sortable" onclick="sortTable(9, 'date')" style="cursor: pointer;">
                                    Last Updated <i class="fas fa-sort text-muted"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="currencyTableBody">
                            <!-- Skeleton Loading Rows -->
                            {% for i in range(10) %}
                            <tr class="skeleton-row" style="display: none;">
                                <td><div class="skeleton-text"></div></td>
                                <td><div class="skeleton-badge"></div></td>
                                <td><div class="skeleton-badge"></div></td>
                                <td><div class="skeleton-badge"></div></td>
                                <td><div class="skeleton-badge"></div></td>
                                <td><div class="skeleton-text"></div></td>
                                <td><div class="skeleton-badge"></div></td>
                                <td><div class="skeleton-text"></div></td>
                                <td><div class="skeleton-text"></div></td>
                                <td><div class="skeleton-text"></div></td>
                            </tr>
                            {% endfor %}
                            
                            {% for item in currency_data %}
                            <tr {% if item.low_confidence %}class="low-confidence"{% endif %}>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if item.icon_url %}
                                            <img src="{{ item.icon_url }}" alt="{{ item.currency_name }}" 
                                                 class="currency-icon me-2" style="width: 32px; height: 32px; object-fit: contain;">
                                        {% endif %}
                                        <div>
                                            <strong>{{ item.currency_name }}</strong>
                                            {% if item.low_confidence %}
                                                <i class="fas fa-exclamation-triangle text-warning" title="Low Confidence"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if item.buy_price %}
                                        <span class="badge bg-success fs-6">
                                            {{ "%.2f"|format(item.buy_price) }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.sell_price %}
                                        <span class="badge bg-danger fs-6">
                                            {{ "%.2f"|format(item.sell_price) }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.price_gap_percentage %}
                                        <div class="price-gap-info">
                                            <span class="badge bg-warning fs-6">
                                                {{ "%.1f"|format(item.price_gap_percentage) }}%
                                            </span>
                                            {% if item.price_gap_absolute %}
                                                <br><small class="text-muted">{{ "%.2f"|format(item.price_gap_absolute) }}</small>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary fs-6">
                                        {{ "%.2f"|format(item.chaos_value) }}
                                    </span>
                                    {% if item.chaos_equivalent and item.chaos_equivalent != item.chaos_value %}
                                        <br><small class="text-muted">Equiv: {{ "%.2f"|format(item.chaos_equivalent) }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="market-depth-info">
                                        <small class="d-block">Count: {{ item.count or 'N/A' }}</small>
                                        <small class="d-block">Listings: {{ item.listing_count or 'N/A' }}</small>
                                        {% if item.data_point_count %}
                                            <small class="d-block text-muted">Data Points: {{ item.data_point_count }}</small>
                                        {% endif %}
                                        {% if item.includes_secondary %}
                                            <span class="badge bg-info badge-sm">Secondary</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if item.low_confidence %}
                                        <span class="badge bg-warning">Low</span>
                                    {% else %}
                                        <span class="badge bg-success">High</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.pay_sparkline %}
                                        <div class="sparkline pay-sparkline" data-sparkline="{{ item.pay_sparkline }}" data-type="pay"></div>
                                    {% else %}
                                        <span class="text-muted">No data</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.receive_sparkline %}
                                        <div class="sparkline receive-sparkline" data-sparkline="{{ item.receive_sparkline }}" data-type="receive"></div>
                                    {% else %}
                                        <span class="text-muted">No data</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ item.extracted_at[:19] if item.extracted_at else 'Unknown' }}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                {% if pagination and pagination.total_pages > 1 %}
                <div class="row mt-4">
                    <div class="col-12">
                        <nav aria-label="Currency pagination">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="pagination-info">
                                    <small class="text-muted">
                                        Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to 
                                        {{ [pagination.page * pagination.per_page, pagination.total] | min }} 
                                        of {{ pagination.total }} currencies
                                    </small>
                                </div>
                                <ul class="pagination pagination-sm mb-0">
                                    <!-- Previous Page -->
                                    <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                                        <a class="page-link" href="{{ url_for('currency_data', league=league, page=pagination.prev_num, per_page=pagination.per_page) if pagination.has_prev else '#' }}">
                                            <i class="fas fa-chevron-left"></i> Previous
                                        </a>
                                    </li>
                                    
                                    <!-- Page Numbers -->
                                    {% set start_page = [1, pagination.page - 2] | max %}
                                    {% set end_page = [pagination.total_pages, pagination.page + 2] | min %}
                                    
                                    {% if start_page > 1 %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('currency_data', league=league, page=1, per_page=pagination.per_page) }}">1</a>
                                        </li>
                                        {% if start_page > 2 %}
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% for page_num in range(start_page, end_page + 1) %}
                                        <li class="page-item {{ 'active' if page_num == pagination.page }}">
                                            <a class="page-link" href="{{ url_for('currency_data', league=league, page=page_num, per_page=pagination.per_page) }}">{{ page_num }}</a>
                                        </li>
                                    {% endfor %}
                                    
                                    {% if end_page < pagination.total_pages %}
                                        {% if end_page < pagination.total_pages - 1 %}
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        {% endif %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('currency_data', league=league, page=pagination.total_pages, per_page=pagination.per_page) }}">{{ pagination.total_pages }}</a>
                                        </li>
                                    {% endif %}
                                    
                                    <!-- Next Page -->
                                    <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                                        <a class="page-link" href="{{ url_for('currency_data', league=league, page=pagination.next_num, per_page=pagination.per_page) if pagination.has_next else '#' }}">
                                            Next <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                                
                                <!-- Items per page selector -->
                                <div class="per-page-selector">
                                    <small class="text-muted me-2">Items per page:</small>
                                    <select class="form-select form-select-sm" style="width: auto; display: inline-block;" onchange="changePerPage(this.value)">
                                        <option value="25" {{ 'selected' if pagination.per_page == 25 }}>25</option>
                                        <option value="50" {{ 'selected' if pagination.per_page == 50 }}>50</option>
                                        <option value="100" {{ 'selected' if pagination.per_page == 100 }}>100</option>
                                        <option value="200" {{ 'selected' if pagination.per_page == 200 }}>200</option>
                                    </select>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
                {% endif %}
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Currency Data Available</h4>
                    <p class="text-muted">Currency data will appear here once the extraction DAG runs successfully.</p>
                    <a href="/" class="btn btn-primary">Back to Dashboard</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Summary Statistics -->
{% if currency_data %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Total Currencies</h5>
                <h2 class="text-primary">{{ currency_data|length }}</h2>
                <small class="text-muted">Active Markets</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Highest Value</h5>
                <h2 class="text-success">
                    {{ "%.2f"|format(currency_data[0].chaos_value) if currency_data else '0' }}
                </h2>
                <small class="text-muted">{{ currency_data[0].currency_name if currency_data else 'N/A' }}</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Market Depth</h5>
                <h2 class="text-info">
                    {% set total_listings = currency_data|sum(attribute='listing_count') if currency_data else 0 %}
                    {{ total_listings }}
                </h2>
                <small class="text-muted">Total Listings</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">Low Confidence</h5>
                <h2 class="text-warning">
                    {{ currency_data|selectattr('low_confidence')|list|length }}
                </h2>
                <small class="text-muted">Items ({{ "%.1f"|format((currency_data|selectattr('low_confidence')|list|length / currency_data|length * 100) if currency_data else 0) }}%)</small>
            </div>
        </div>
    </div>
</div>

<!-- Additional Market Insights -->
<div class="row mt-3">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-chart-line text-success"></i> Market Activity</h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Avg Listings</small>
                        <div class="fw-bold">
                            {% set avg_listings = (currency_data|sum(attribute='listing_count') / currency_data|length) if currency_data else 0 %}
                            {{ "%.0f"|format(avg_listings) }}
                        </div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Secondary Markets</small>
                        <div class="fw-bold">
                            {{ currency_data|selectattr('includes_secondary')|list|length }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-coins text-warning"></i> Value Distribution</h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Median Value</small>
                        <div class="fw-bold">
                            {% set sorted_values = currency_data|map(attribute='chaos_value')|list|sort %}
                            {% set median_idx = (sorted_values|length // 2) %}
                            {{ "%.2f"|format(sorted_values[median_idx] if sorted_values else 0) }}
                        </div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">High Value (>100)</small>
                        <div class="fw-bold">
                            {{ currency_data|selectattr('chaos_value', '>', 100)|list|length }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-database text-info"></i> Data Quality</h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Avg Data Points</small>
                        <div class="fw-bold">
                            {% set valid_data_points = currency_data|selectattr('data_point_count')|list %}
                            {% set avg_data_points = (valid_data_points|sum(attribute='data_point_count') / valid_data_points|length) if valid_data_points else 0 %}
                            {{ "%.1f"|format(avg_data_points) }}
                        </div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">High Confidence</small>
                        <div class="fw-bold text-success">
                            {{ currency_data|rejectattr('low_confidence')|list|length }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Enhanced sparkline implementation with pay/receive types
document.addEventListener('DOMContentLoaded', function() {
    const sparklines = document.querySelectorAll('.sparkline');
    
    sparklines.forEach(function(element) {
        const data = element.getAttribute('data-sparkline');
        const type = element.getAttribute('data-type') || 'default';
        
        if (data) {
            try {
                const sparklineData = JSON.parse(data);
                let values = [];
                let totalChange = 0;
                
                // Handle different data formats
                if (sparklineData && sparklineData.data && Array.isArray(sparklineData.data)) {
                    values = sparklineData.data;
                    totalChange = sparklineData.totalChange || 0;
                } else if (Array.isArray(sparklineData)) {
                    values = sparklineData;
                }
                
                if (values && values.length > 0) {
                    // Create enhanced trend indicator with mini chart
                    const first = values[0] || 0;
                    const last = values[values.length - 1] || 0;
                    const change = totalChange || (last - first);
                    
                    // Determine trend and color based on type
                    let trend, color, bgColor;
                    if (change > 0) {
                        trend = '↗';
                        color = type === 'pay' ? 'text-success' : 'text-primary';
                        bgColor = type === 'pay' ? 'bg-success' : 'bg-primary';
                    } else if (change < 0) {
                        trend = '↘';
                        color = 'text-danger';
                        bgColor = 'bg-danger';
                    } else {
                        trend = '→';
                        color = 'text-muted';
                        bgColor = 'bg-secondary';
                    }
                    
                    // Create mini SVG chart
                    const width = 60;
                    const height = 20;
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    const range = max - min || 1;
                    
                    let pathData = '';
                    values.forEach((value, index) => {
                        const x = (index / (values.length - 1)) * width;
                        const y = height - ((value - min) / range) * height;
                        pathData += index === 0 ? `M${x},${y}` : ` L${x},${y}`;
                    });
                    
                    const typeLabel = type === 'pay' ? 'Pay' : type === 'receive' ? 'Receive' : '';
                    
                    element.innerHTML = `
                        <div class="d-flex align-items-center">
                            <svg width="${width}" height="${height}" class="me-2">
                                <path d="${pathData}" stroke="${change > 0 ? '#28a745' : change < 0 ? '#dc3545' : '#6c757d'}" 
                                      stroke-width="1.5" fill="none"/>
                            </svg>
                            <div>
                                <span class="${color}">${trend}</span>
                                <small class="d-block text-muted">${typeLabel}</small>
                                <small class="d-block ${color}">${change > 0 ? '+' : ''}${change.toFixed(2)}%</small>
                            </div>
                        </div>
                    `;
                } else {
                    element.innerHTML = '<span class="text-muted">—</span>';
                }
            } catch (e) {
                console.error('Error parsing sparkline data:', e);
                element.innerHTML = '<span class="text-muted">—</span>';
            }
        }
    });
});

// Advanced filtering functionality
function toggleAdvancedFilters() {
    const panel = document.getElementById('advancedFilters');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
}

function clearAllFilters() {
    document.getElementById('currencySearch').value = '';
    document.getElementById('confidenceFilter').value = '';
    document.getElementById('chaosMin').value = '';
    document.getElementById('chaosMax').value = '';
    document.getElementById('divineMin').value = '';
    document.getElementById('divineMax').value = '';
    applyAllFilters();
}

function applyAllFilters() {
    const searchInput = document.getElementById('currencySearch');
    const searchFilter = searchInput.value.toLowerCase();
    const confidenceFilter = document.getElementById('confidenceFilter').value;
    const chaosMin = parseFloat(document.getElementById('chaosMin').value) || 0;
    const chaosMax = parseFloat(document.getElementById('chaosMax').value) || Infinity;
    const divineMin = parseFloat(document.getElementById('divineMin').value) || 0;
    const divineMax = parseFloat(document.getElementById('divineMax').value) || Infinity;
    
    const tableBody = document.getElementById('currencyTableBody');
    const rows = tableBody.querySelectorAll('tr:not(.skeleton-row)');
    const resultCount = document.getElementById('resultCount');
    
    let visibleCount = 0;
    
    // Brief loading indication for search
    if (searchFilter.length > 0) {
        resultCount.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        setTimeout(() => {
            performFilter();
        }, 100);
    } else {
        performFilter();
    }
    
    function performFilter() {
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            if (cells.length >= 7) {
                const currencyName = cells[0].textContent.toLowerCase();
                const chaosValue = parseFloat(cells[1].textContent) || 0;
                const divineValue = parseFloat(cells[2].textContent) || 0;
                const confidence = cells[4].textContent.toLowerCase();
                
                let showRow = true;
                
                // Apply search filter
                if (searchFilter && !currencyName.includes(searchFilter)) {
                    showRow = false;
                }
                
                // Apply confidence filter
                if (confidenceFilter) {
                    if (confidenceFilter === 'high' && confidence.includes('low')) {
                        showRow = false;
                    } else if (confidenceFilter === 'low' && !confidence.includes('low')) {
                        showRow = false;
                    }
                }
                
                // Apply chaos value range filter
                if (chaosValue < chaosMin || chaosValue > chaosMax) {
                    showRow = false;
                }
                
                // Apply divine value range filter
                if (divineValue < divineMin || divineValue > divineMax) {
                    showRow = false;
                }
                
                if (showRow) {
                    rows[i].style.display = '';
                    visibleCount++;
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
        
        // Update result count
        resultCount.textContent = visibleCount;
    }
}

// Table sorting functionality
let sortDirection = {};

function sortTable(columnIndex, dataType) {
    const table = document.querySelector('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    const currentDirection = sortDirection[columnIndex] || 'asc';
    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
    sortDirection[columnIndex] = newDirection;
    
    // Update sort icons
    updateSortIcons(columnIndex, newDirection);
    
    // Sort rows
    rows.sort((a, b) => {
        const aCell = a.cells[columnIndex];
        const bCell = b.cells[columnIndex];
        
        let aValue, bValue;
        
        switch (dataType) {
            case 'number':
                aValue = parseFloat(aCell.textContent.replace(/[^\d.-]/g, '')) || 0;
                bValue = parseFloat(bCell.textContent.replace(/[^\d.-]/g, '')) || 0;
                break;
            case 'date':
                aValue = new Date(aCell.textContent.trim());
                bValue = new Date(bCell.textContent.trim());
                break;
            case 'string':
            default:
                aValue = aCell.textContent.trim().toLowerCase();
                bValue = bCell.textContent.trim().toLowerCase();
                break;
        }
        
        if (aValue < bValue) return newDirection === 'asc' ? -1 : 1;
        if (aValue > bValue) return newDirection === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update result count after sorting
    updateVisibleCount();
}

function updateSortIcons(activeColumn, direction) {
    const headers = document.querySelectorAll('th.sortable');
    headers.forEach((header, index) => {
        const icon = header.querySelector('i');
        if (index === activeColumn) {
            icon.className = direction === 'asc' ? 'fas fa-sort-up text-primary' : 'fas fa-sort-down text-primary';
        } else {
            icon.className = 'fas fa-sort text-muted';
        }
    });
}

function updateVisibleCount() {
    const tableBody = document.getElementById('currencyTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    for (let i = 0; i < rows.length; i++) {
        if (rows[i].style.display !== 'none') {
            visibleCount++;
        }
    }
    
    document.getElementById('resultCount').textContent = visibleCount;
}

// Handle per-page selector change
function changePerPage() {
    showLoadingState();
    const perPage = document.getElementById('perPageSelect').value;
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('per_page', perPage);
    urlParams.set('page', '1'); // Reset to first page
    window.location.search = urlParams.toString();
}

// Loading state functions
function showLoadingState() {
    const loadingElement = document.getElementById('loadingState');
    if (loadingElement) loadingElement.style.display = 'block';
    
    const tableBody = document.getElementById('currencyTableBody');
    const skeletonRows = tableBody.querySelectorAll('.skeleton-row');
    const dataRows = tableBody.querySelectorAll('tr:not(.skeleton-row)');
    
    skeletonRows.forEach(row => row.style.display = '');
    dataRows.forEach(row => row.style.display = 'none');
}

function hideLoadingState() {
    const loadingElement = document.getElementById('loadingState');
    if (loadingElement) loadingElement.style.display = 'none';
    
    const tableBody = document.getElementById('currencyTableBody');
    if (tableBody) {
        const skeletonRows = tableBody.querySelectorAll('.skeleton-row');
        const dataRows = tableBody.querySelectorAll('tr:not(.skeleton-row)');
        
        skeletonRows.forEach(row => row.style.display = 'none');
        dataRows.forEach(row => row.style.display = '');
    }
}

// Export functionality
        function exportData(format) {
            const tableBody = document.getElementById('currencyTableBody');
            const visibleRows = Array.from(tableBody.querySelectorAll('tr:not(.skeleton-row)')).
                filter(row => row.style.display !== 'none');
            
            const data = visibleRows.map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    currency_name: cells[0].textContent.trim(),
                    buy_price: parseFloat(cells[1].textContent.trim()) || 0,
                    sell_price: parseFloat(cells[2].textContent.trim()) || 0,
                    price_gap_percentage: parseFloat(cells[3].textContent.trim()) || 0,
                    chaos_value: parseFloat(cells[4].textContent.trim()) || 0,
                    count: parseInt(cells[5].textContent.trim()) || 0,
                    confidence: cells[6].textContent.trim(),
                    last_updated: cells[9].textContent.trim()
                };
            });
            
            if (format === 'csv') {
                exportToCSV(data);
            } else if (format === 'json') {
                exportToJSON(data);
            }
        }
        
        function exportToCSV(data) {
            const headers = ['Currency Name', 'Buy Price', 'Sell Price', 'Price Gap %', 'Chaos Value', 'Count', 'Confidence', 'Last Updated'];
            const csvContent = [headers.join(',')];
            
            data.forEach(row => {
                const csvRow = [
                    `"${row.currency_name}"`,
                    row.buy_price,
                    row.sell_price,
                    row.price_gap_percentage,
                    row.chaos_value,
                    row.count,
                    `"${row.confidence}"`,
                    `"${row.last_updated}"`
                ].join(',');
                csvContent.push(csvRow);
            });
            
            downloadFile(csvContent.join('\n'), 'currency_data.csv', 'text/csv');
        }
        
        function exportToJSON(data) {
            const jsonContent = JSON.stringify(data, null, 2);
            downloadFile(jsonContent, 'currency_data.json', 'application/json');
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }
        
        // Add loading state to pagination links
        document.addEventListener('DOMContentLoaded', function() {
            const paginationLinks = document.querySelectorAll('.pagination a');
            paginationLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    if (!this.classList.contains('disabled')) {
                        showLoadingState();
                    }
                });
            });
            
            // Hide loading state when page loads
            hideLoadingState();
        });
</script>

<style>
/* Enhanced Market Depth Styling */
.market-depth-info {
    font-size: 0.85rem;
    line-height: 1.2;
}

.market-depth-info .badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
}

/* Sparkline Container Styling */
.sparkline {
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.pay-sparkline {
    border-left: 3px solid #28a745;
    padding-left: 8px;
}

.receive-sparkline {
    border-left: 3px solid #007bff;
    padding-left: 8px;
}

/* Enhanced table styling */
.table td {
    vertical-align: middle;
}

.low-confidence {
    background-color: rgba(255, 193, 7, 0.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .market-depth-info {
        font-size: 0.75rem;
    }
    
    .sparkline svg {
        width: 40px;
        height: 15px;
    }
}

/* Loading skeleton animations */
.skeleton-text, .skeleton-badge {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    height: 1rem;
}

.skeleton-badge {
    width: 60px;
    height: 1.5rem;
    border-radius: 12px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}
</style>
{% endblock %}