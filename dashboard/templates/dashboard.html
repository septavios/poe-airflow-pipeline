{% extends "base.html" %}

{% block title %}POE Market Dashboard{% endblock %}

{% block content %}
<!-- Compact Header -->
<div class="compact-header mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0"><i class="fas fa-chart-line"></i> Market Overview</h2>
        <div class="last-update">
            <small class="text-muted">Last Update: 
                {% if stats.last_update != 'Never' %}
                    {{ stats.last_update[:16] }}
                {% else %}
                    Never
                {% endif %}
            </small>
        </div>
    </div>
</div>

<!-- Compact Statistics Row -->
<div class="stats-row mb-3">
    <div class="stat-item">
        <div class="stat-value">{{ stats.currency_count }}</div>
        <div class="stat-label">Currencies</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.gems_count }}</div>
        <div class="stat-label">Gems</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.cards_count }}</div>
        <div class="stat-label">Cards</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.profit_count }}</div>
        <div class="stat-label">Opportunities</div>
    </div>
    <div class="stat-item">
        <div class="stat-value">{{ stats.summary_count }}</div>
        <div class="stat-label">Summaries</div>
    </div>
</div>

<!-- Compact Charts Row -->
<div class="row g-2 mb-3">
    <div class="col-md-6">
        <div class="compact-card">
            <div class="compact-card-header">
                <i class="fas fa-coins"></i> Top Currencies
            </div>
            <div class="compact-card-body">
                <canvas id="currencyChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="compact-card">
            <div class="compact-card-header">
                <i class="fas fa-chart-line"></i> Profit Opportunities
            </div>
            <div class="compact-card-body">
                <canvas id="profitChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Compact Navigation Grid -->
<div class="nav-grid">
    <a href="/currency" class="nav-item">
        <i class="fas fa-coins"></i>
        <span>Currency</span>
    </a>
    <a href="/gems" class="nav-item">
        <i class="fas fa-gem"></i>
        <span>Gems</span>
    </a>
    <a href="/cards" class="nav-item">
        <i class="fas fa-id-card"></i>
        <span>Cards</span>
    </a>
    <a href="/profit" class="nav-item">
        <i class="fas fa-chart-line"></i>
        <span>Profit</span>
    </a>
    <a href="/market-summary" class="nav-item">
        <i class="fas fa-chart-bar"></i>
        <span>Summary</span>
    </a>
    <a href="http://localhost:8080" target="_blank" class="nav-item">
        <i class="fas fa-cogs"></i>
        <span>Airflow</span>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// Currency Chart
fetch('/api/currency-chart')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('currencyChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.currency_name),
                datasets: [{
                    label: 'Chaos Equivalent',
                    data: data.map(item => item.chaos_value),
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading currency chart:', error);
        document.getElementById('currencyChart').parentElement.innerHTML = 
            '<p class="text-muted text-center">No currency data available</p>';
    });

// Profit Chart
fetch('/api/profit-chart')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('profitChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.item_name.length > 20 ? 
                    item.item_name.substring(0, 20) + '...' : item.item_name),
                datasets: [{
                    label: 'Profit Percentage',
                    data: data.map(item => item.profit_percentage),
                    backgroundColor: 'rgba(245, 87, 108, 0.8)',
                    borderColor: 'rgba(245, 87, 108, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading profit chart:', error);
        document.getElementById('profitChart').parentElement.innerHTML = 
            '<p class="text-muted text-center">No profit data available</p>';
    });
</script>
{% endblock %}