{% extends "base.html" %}

{% block title %}Arbitrage Opportunities - POE Market Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-exchange-alt"></i> Currency Arbitrage Opportunities</h1>
        <p class="text-muted">Real-time arbitrage opportunities based on buy/sell price differences</p>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_currencies or 0 }}</div>
            <div class="stat-label">Total Currencies</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ stats.profitable_opportunities or 0 }}</div>
            <div class="stat-label">Profitable Opportunities</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ "%.2f"|format(stats.avg_spread_percentage or 0) }}%</div>
            <div class="stat-label">Average Spread</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ "%.2f"|format(stats.max_spread_percentage or 0) }}%</div>
            <div class="stat-label">Max Spread</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Top Arbitrage Opportunities</h5>
            </div>
            <div class="card-body">
                <canvas id="arbitrageChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-scatter"></i> Spread vs Confidence</h5>
            </div>
            <div class="card-body">
                <canvas id="confidenceChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Arbitrage Opportunities Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-table"></i> Arbitrage Opportunities</h5>
                <div class="d-flex align-items-center">
                    <label for="filterOpportunities" class="form-label me-2 mb-0">Filter:</label>
                    <select id="filterOpportunities" class="form-select form-select-sm" style="width: auto;">
                        <option value="all">All Currencies</option>
                        <option value="profitable">Profitable Only</option>
                        <option value="high-confidence">High Confidence (50+)</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" id="arbitrageTable">
                        <thead>
                            <tr>
                                <th>Currency</th>
                                <th>Buy Price (Chaos)</th>
                                <th>Sell Price (Chaos)</th>
                                <th>Spread (Chaos)</th>
                                <th>Spread %</th>
                                <th>Listing Diff</th>
                                <th>Pay Listings</th>
                                <th>Receive Listings</th>
                                <th>Confidence</th>
                                <th>Opportunity</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in arbitrage_data %}
                            <tr class="arbitrage-row" 
                                data-profitable="{{ 'true' if item.arbitrage_opportunity else 'false' }}"
                                data-confidence="{{ item.confidence_score or 0 }}">
                                <td>
                                    <strong>{{ item.currency_name }}</strong>
                                </td>
                                <td>
                                    <span class="text-warning">{{ "%.4f"|format(item.buy_price_chaos or 0) }}</span>
                                </td>
                                <td>
                                    <span class="text-info">{{ "%.4f"|format(item.sell_price_chaos or 0) }}</span>
                                </td>
                                <td>
                                    <span class="{% if item.spread_chaos and item.spread_chaos > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        {{ "%.4f"|format(item.spread_chaos or 0) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="{% if item.spread_percentage and item.spread_percentage > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        {{ "%.2f"|format(item.spread_percentage or 0) }}%
                                    </span>
                                </td>
                                <td>
                                    <span class="{% if item.listing_count_difference and item.listing_count_difference > 0 %}text-success{% elif item.listing_count_difference and item.listing_count_difference < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {{ item.listing_count_difference or 0 }}
                                    </span>
                                </td>
                                <td>{{ item.pay_listing_count or 0 }}</td>
                                <td>{{ item.receive_listing_count or 0 }}</td>
                                <td>
                                    <span class="badge {% if item.confidence_score and item.confidence_score >= 50 %}bg-success{% elif item.confidence_score and item.confidence_score >= 20 %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ item.confidence_score or 0 }}
                                    </span>
                                </td>
                                <td>
                                    {% if item.arbitrage_opportunity %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Yes
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times"></i> No
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if item.extracted_at %}
                                            {{ item.extracted_at[:19] }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Understanding Arbitrage Opportunities</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Key Metrics:</h6>
                        <ul>
                            <li><strong>Buy Price:</strong> Price to acquire the currency (1/pay_value)</li>
                            <li><strong>Sell Price:</strong> Price to sell the currency (receive_value)</li>
                            <li><strong>Spread:</strong> Difference between sell and buy price</li>
                            <li><strong>Spread %:</strong> Percentage profit potential</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Confidence Levels:</h6>
                        <ul>
                            <li><span class="badge bg-success">High (50+)</span> - Many listings, reliable data</li>
                            <li><span class="badge bg-warning">Medium (20-49)</span> - Moderate listings</li>
                            <li><span class="badge bg-secondary">Low (<20)</span> - Few listings, higher risk</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const filterSelect = document.getElementById('filterOpportunities');
    const tableRows = document.querySelectorAll('.arbitrage-row');
    
    filterSelect.addEventListener('change', function() {
        const filterValue = this.value;
        
        tableRows.forEach(row => {
            const isProfitable = row.dataset.profitable === 'true';
            const confidence = parseInt(row.dataset.confidence) || 0;
            
            let showRow = true;
            
            switch(filterValue) {
                case 'profitable':
                    showRow = isProfitable;
                    break;
                case 'high-confidence':
                    showRow = confidence >= 50;
                    break;
                case 'all':
                default:
                    showRow = true;
                    break;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    });
    
    // Load arbitrage chart data
    fetch(`/api/arbitrage-chart?league={{ league }}`)
        .then(response => response.json())
        .then(data => {
            createArbitrageChart(data);
            createConfidenceChart(data);
        })
        .catch(error => {
            console.error('Error loading arbitrage chart data:', error);
        });
});

function createArbitrageChart(data) {
    const ctx = document.getElementById('arbitrageChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.slice(0, 10).map(item => item.currency_name),
            datasets: [{
                label: 'Spread Percentage',
                data: data.slice(0, 10).map(item => item.spread_percentage),
                backgroundColor: 'rgba(79, 209, 199, 0.8)',
                borderColor: 'rgba(79, 209, 199, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e8e8e8'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#e8e8e8',
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e8e8e8',
                        maxRotation: 45
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

function createConfidenceChart(data) {
    const ctx = document.getElementById('confidenceChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Arbitrage Opportunities',
                data: data.map(item => ({
                    x: item.confidence_score,
                    y: item.spread_percentage
                })),
                backgroundColor: 'rgba(79, 209, 199, 0.6)',
                borderColor: 'rgba(79, 209, 199, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e8e8e8'
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            return data[dataIndex].currency_name;
                        },
                        label: function(context) {
                            return [
                                `Confidence: ${context.parsed.x}`,
                                `Spread: ${context.parsed.y.toFixed(2)}%`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Spread Percentage (%)',
                        color: '#e8e8e8'
                    },
                    ticks: {
                        color: '#e8e8e8'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Confidence Score',
                        color: '#e8e8e8'
                    },
                    ticks: {
                        color: '#e8e8e8'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}