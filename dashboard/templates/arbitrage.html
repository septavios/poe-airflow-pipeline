{% extends "base.html" %}

{% block title %}Arbitrage Opportunities - POE Market Dashboard{% endblock %}

{% block content %}
<div class="row mb-2">
    <div class="col-12">
        <h3 class="mb-1"><i class="fas fa-exchange-alt"></i> Currency Arbitrage Opportunities</h3>
        <p class="text-muted small mb-2">Real-time arbitrage opportunities based on buy/sell price differences</p>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-2">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_currencies or 0 }}</div>
            <div class="stat-label">Total Currencies</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ stats.profitable_opportunities or 0 }}</div>
            <div class="stat-label">Profitable Opportunities</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ "%.2f"|format(stats.avg_spread_percentage or 0) }}%</div>
            <div class="stat-label">Average Spread</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-number">{{ "%.2f"|format(stats.max_spread_percentage or 0) }}%</div>
            <div class="stat-label">Max Spread</div>
        </div>
    </div>
</div>

<!-- Profit Calculator Widget -->
<div class="row mb-2">
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header py-2">
                <h6 class="card-title mb-0">
                    <i class="fas fa-calculator text-success"></i> Profit Calculator
                </h6>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <label for="investmentAmount" class="form-label small">Investment (Chaos Orbs)</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" 
                                   id="investmentAmount" placeholder="100" min="1" step="1">
                        </div>
                        <div class="mb-2">
                            <label for="spreadPercentage" class="form-label small">Spread %</label>
                            <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" 
                                   id="spreadPercentage" placeholder="15.5" min="0" step="0.1">
                        </div>
                        <button type="button" class="btn btn-success btn-sm" onclick="calculateProfit()">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="profit-results">
                            <div class="mb-1">
                                <small class="text-muted">Potential Profit:</small>
                                <div class="h6 text-success" id="profitAmount">-</div>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">Total Return:</small>
                                <div class="small text-info" id="totalReturn">-</div>
                            </div>
                            <div class="mb-1">
                                <small class="text-muted">ROI:</small>
                                <div class="small text-warning" id="roiPercentage">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Calculator assumes perfect execution without fees or market changes.
                    </small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header py-2">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-line text-info"></i> Quick Stats
                </h6>
            </div>
            <div class="card-body py-2">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="h6 text-success mb-0" id="avgSpread">-</div>
                            <small class="text-muted">Avg Spread</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="h6 text-warning mb-0" id="topSpread">-</div>
                            <small class="text-muted">Top Spread</small>
                        </div>
                    </div>
                </div>
                <div class="row text-center mt-2">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="h6 text-info mb-0" id="highConfCount">-</div>
                            <small class="text-muted">High Confidence</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="h6 text-primary mb-0" id="totalOpps">-</div>
                            <small class="text-muted">Total Opps</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-2">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header py-2">
                <h6><i class="fas fa-chart-bar"></i> Top Arbitrage Opportunities</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="arbitrageChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header py-2">
                <h6><i class="fas fa-chart-scatter"></i> Spread vs Confidence</h6>
            </div>
            <div class="card-body py-2">
                <canvas id="confidenceChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Arbitrage Opportunities Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6><i class="fas fa-table"></i> Arbitrage Opportunities</h6>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-outline-info btn-sm" id="refreshData" title="Refresh Data">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="exportData" title="Export to CSV">
                            <i class="fas fa-download"></i>
                        </button>
                        <div class="btn-group ms-2" role="group">
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i> Auto Refresh: OFF
                            </button>
                            <select class="form-select form-select-sm bg-dark text-light border-secondary" id="refreshInterval" style="max-width: 120px;">
                                <option value="30">30s</option>
                                <option value="60" selected>1m</option>
                                <option value="300">5m</option>
                                <option value="600">10m</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters Row -->
                <div class="row g-2">
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchCurrency" placeholder="Search currency...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select id="filterOpportunities" class="form-select form-select-sm">
                            <option value="all">All Currencies</option>
                            <option value="profitable">Profitable Only</option>
                            <option value="high-confidence">High Confidence (50+)</option>
                            <option value="low-confidence">Low Confidence</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="sortBy" class="form-select form-select-sm">
                            <option value="spread_desc">Spread % (High to Low)</option>
                            <option value="spread_asc">Spread % (Low to High)</option>
                            <option value="confidence_desc">Confidence (High to Low)</option>
                            <option value="confidence_asc">Confidence (Low to High)</option>
                            <option value="name_asc">Name (A to Z)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="spreadFilter" class="form-select form-select-sm">
                            <option value="all">All Spreads</option>
                            <option value="high">High Spread (>5%)</option>
                            <option value="medium">Medium Spread (1-5%)</option>
                            <option value="low">Low Spread (<1%)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="rowsPerPage" class="form-select form-select-sm">
                            <option value="25">Show 25</option>
                            <option value="50">Show 50</option>
                            <option value="100">Show 100</option>
                            <option value="all">Show All</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                         <button class="btn btn-outline-warning btn-sm w-100" id="clearFilters" title="Clear All Filters">
                             <i class="fas fa-times"></i>
                         </button>
                     </div>
                 </div>
                 
                 <!-- Column Visibility Controls -->
                 <div class="row g-1 mt-1">
                     <div class="col-12">
                         <div class="d-flex align-items-center gap-1 flex-wrap">
                             <small class="text-muted me-1">Columns:</small>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-buy-price" checked data-column="1">
                                 <label class="form-check-label" for="col-buy-price">Buy Price</label>
                             </div>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-sell-price" checked data-column="2">
                                 <label class="form-check-label" for="col-sell-price">Sell Price</label>
                             </div>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-spread-chaos" checked data-column="3">
                                 <label class="form-check-label" for="col-spread-chaos">Spread (Chaos)</label>
                             </div>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-listing-diff" checked data-column="5">
                                 <label class="form-check-label" for="col-listing-diff">Listing Diff</label>
                             </div>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-pay-listings" checked data-column="6">
                                 <label class="form-check-label" for="col-pay-listings">Pay Listings</label>
                             </div>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-receive-listings" checked data-column="7">
                                 <label class="form-check-label" for="col-receive-listings">Receive Listings</label>
                             </div>
                             <div class="form-check form-check-inline">
                                 <input class="form-check-input column-toggle" type="checkbox" id="col-last-updated" checked data-column="10">
                                 <label class="form-check-label" for="col-last-updated">Last Updated</label>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm mb-0" id="arbitrageTable">
                        <thead>
                            <tr>
                                <th>Currency</th>
                                <th>Buy Price (Chaos)</th>
                                <th>Sell Price (Chaos)</th>
                                <th>Spread (Chaos)</th>
                                <th>Spread %</th>
                                <th>Listing Diff</th>
                                <th>Pay Listings</th>
                                <th>Receive Listings</th>
                                <th>Confidence</th>
                                <th>Opportunity</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in arbitrage_data %}
                            <tr class="arbitrage-row" 
                                data-profitable="{{ 'true' if item.arbitrage_opportunity else 'false' }}"
                                data-confidence="{{ item.confidence_score or 0 }}">
                                <td>
                                    <a href="#" class="currency-link text-decoration-none" 
                                       data-currency="{{ item.currency_name }}"
                                       data-buy-price="{{ item.buy_price_chaos or 0 }}"
                                       data-sell-price="{{ item.sell_price_chaos or 0 }}"
                                       data-spread="{{ item.spread_percentage or 0 }}"
                                       data-confidence="{{ item.confidence_score or 0 }}"
                                       data-pay-listings="{{ item.pay_listing_count or 0 }}"
                                       data-receive-listings="{{ item.receive_listing_count or 0 }}"
                                       data-last-updated="{{ item.extracted_at or '' }}">
                                        <strong>{{ item.currency_name }}</strong>
                                    </a>
                                </td>
                                <td>
                                    <span class="text-warning">{{ "%.4f"|format(item.buy_price_chaos or 0) }}</span>
                                </td>
                                <td>
                                    <span class="text-info">{{ "%.4f"|format(item.sell_price_chaos or 0) }}</span>
                                </td>
                                <td>
                                    <span class="{% if item.spread_chaos and item.spread_chaos > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        {{ "%.4f"|format(item.spread_chaos or 0) }}
                                    </span>
                                </td>
                                <td>
                                    <span class="{% if item.spread_percentage and item.spread_percentage > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        {{ "%.2f"|format(item.spread_percentage or 0) }}%
                                    </span>
                                </td>
                                <td>
                                    <span class="{% if item.listing_count_difference and item.listing_count_difference > 0 %}text-success{% elif item.listing_count_difference and item.listing_count_difference < 0 %}text-danger{% else %}text-muted{% endif %}">
                                        {{ item.listing_count_difference or 0 }}
                                    </span>
                                </td>
                                <td>{{ item.pay_listing_count or 0 }}</td>
                                <td>{{ item.receive_listing_count or 0 }}</td>
                                <td>
                                    <span class="badge {% if item.confidence_score and item.confidence_score >= 50 %}bg-success{% elif item.confidence_score and item.confidence_score >= 20 %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ item.confidence_score or 0 }}
                                    </span>
                                </td>
                                <td>
                                    {% if item.arbitrage_opportunity %}
                                        {% if item.spread_percentage >= 20 %}
                                            <span class="badge bg-success profit-badge profit-excellent animated-pulse">
                                                <i class="fas fa-gem"></i> Excellent
                                            </span>
                                        {% elif item.spread_percentage >= 15 %}
                                            <span class="badge bg-warning profit-badge profit-high animated-glow">
                                                <i class="fas fa-star"></i> High
                                            </span>
                                        {% elif item.spread_percentage >= 10 %}
                                            <span class="badge bg-info profit-badge profit-good">
                                                <i class="fas fa-thumbs-up"></i> Good
                                            </span>
                                        {% else %}
                                            <span class="badge bg-success profit-badge profit-low">
                                                <i class="fas fa-check"></i> Low
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary profit-badge">
                                            <i class="fas fa-times"></i> No
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {% if item.extracted_at %}
                                            {{ item.extracted_at[:19] }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination and Results Info -->
                <div class="card-footer py-2 d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        <span id="resultsInfo">Showing 0 of 0 results</span>
                    </div>
                    <nav aria-label="Table pagination">
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                            <!-- Pagination will be generated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Section -->
<div class="row mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header py-2">
                <h6><i class="fas fa-info-circle"></i> Understanding Arbitrage Opportunities</h6>
            </div>
            <div class="card-body py-2">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Key Metrics:</h6>
                        <ul>
                            <li><strong>Buy Price:</strong> Price to acquire the currency (1/pay_value)</li>
                            <li><strong>Sell Price:</strong> Price to sell the currency (receive_value)</li>
                            <li><strong>Spread:</strong> Difference between sell and buy price</li>
                            <li><strong>Spread %:</strong> Percentage profit potential</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Confidence Levels:</h6>
                        <ul>
                            <li><span class="badge bg-success">High (50+)</span> - Many listings, reliable data</li>
                            <li><span class="badge bg-warning">Medium (20-49)</span> - Moderate listings</li>
                            <li><span class="badge bg-secondary">Low (<20)</span> - Few listings, higher risk</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Currency Details Modal -->
<div class="modal fade" id="currencyModal" tabindex="-1" aria-labelledby="currencyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="currencyModalLabel">
                    <i class="fas fa-coins text-warning"></i> 
                    <span id="modalCurrencyName">Currency Details</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-secondary border-0 mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-line"></i> Price Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h5 text-warning" id="modalBuyPrice">-</div>
                                            <small class="text-muted">Buy Price (Chaos)</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h5 text-info" id="modalSellPrice">-</div>
                                            <small class="text-muted">Sell Price (Chaos)</small>
                                        </div>
                                    </div>
                                </div>
                                <hr class="border-secondary">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h4 text-success" id="modalSpreadPercentage">-</div>
                                            <small class="text-muted">Spread Percentage</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h5" id="modalConfidenceScore">-</div>
                                            <small class="text-muted">Confidence Score</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-secondary border-0 mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-list"></i> Market Activity</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h5 text-primary" id="modalPayListings">-</div>
                                            <small class="text-muted">Pay Listings</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <div class="h5 text-primary" id="modalReceiveListings">-</div>
                                            <small class="text-muted">Receive Listings</small>
                                        </div>
                                    </div>
                                </div>
                                <hr class="border-secondary">
                                <div class="text-center">
                                    <small class="text-muted">Last Updated:</small>
                                    <div id="modalLastUpdated" class="text-light">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Profit Calculator for this currency -->
                <div class="card bg-secondary border-0">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-calculator text-success"></i> Profit Calculator</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="modalInvestmentAmount" class="form-label small">Investment (Chaos)</label>
                                <input type="number" class="form-control form-control-sm bg-dark text-light border-secondary" 
                                       id="modalInvestmentAmount" placeholder="100" min="1" step="1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Potential Profit</label>
                                <div class="h6 text-success" id="modalPotentialProfit">-</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">Total Return</label>
                                <div class="h6 text-info" id="modalTotalReturn">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Trading Strategy Tips -->
                <div class="mt-2">
                    <div class="alert alert-info py-2" role="alert">
                        <h6><i class="fas fa-lightbulb"></i> Trading Tips:</h6>
                        <ul class="mb-0 small">
                            <li>Higher confidence scores indicate more reliable data</li>
                            <li>Check market depth before making large trades</li>
                            <li>Consider transaction fees and market volatility</li>
                            <li>Monitor price changes in real-time</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="openPoeNinjaLink()">
                    <i class="fas fa-external-link-alt"></i> View on poe.ninja
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.filter-controls {
    background: rgba(52, 58, 64, 0.8);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.column-controls {
    background: rgba(52, 58, 64, 0.6);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 15px;
}

.pagination-info {
    color: #adb5bd;
    font-size: 0.9em;
}

.table th {
    cursor: pointer;
    user-select: none;
}

.table th:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.table th i {
    margin-left: 5px;
    font-size: 0.8em;
}

/* Enhanced Visual Indicators */
.profit-badge {
    font-size: 0.85em;
    padding: 6px 10px;
    border-radius: 20px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.profit-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}

.profit-excellent {
    background: linear-gradient(45deg, #28a745, #20c997) !important;
    border: 2px solid #ffd700;
}

.profit-high {
    background: linear-gradient(45deg, #ffc107, #fd7e14) !important;
    color: #000 !important;
}

.profit-good {
    background: linear-gradient(45deg, #17a2b8, #6f42c1) !important;
}

.profit-low {
    background: linear-gradient(45deg, #28a745, #6c757d) !important;
}

/* Animations */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes glow {
    0% { box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 4px 12px rgba(255, 193, 7, 0.6); }
    100% { box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
}

.animated-pulse {
    animation: pulse 2s infinite;
}

.animated-glow {
    animation: glow 3s infinite;
}

/* Spread percentage color coding */
.spread-excellent { color: #28a745 !important; font-weight: bold; }
.spread-high { color: #ffc107 !important; font-weight: bold; }
.spread-good { color: #17a2b8 !important; font-weight: bold; }
.spread-low { color: #6c757d !important; }

/* Confidence level indicators */
.confidence-high { color: #28a745 !important; font-weight: bold; }
.confidence-medium { color: #ffc107 !important; }
.confidence-low { color: #dc3545 !important; }

/* Currency link styling */
.currency-link {
    color: inherit;
    transition: all 0.3s ease;
}

.currency-link:hover {
    color: #4fd1c7 !important;
    text-shadow: 0 0 5px rgba(79, 209, 199, 0.5);
}

/* Modal enhancements */
.modal-content {
    border: 1px solid #495057;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.modal-header {
    background: linear-gradient(45deg, #343a40, #495057);
}

.stat-item {
    padding: 10px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
    margin-bottom: 10px;
}
</style>

<script>
// Global variables
let allRows, filteredRows, currentPage = 1, rowsPerPage = 25;
let autoRefreshInterval = null;
let isAutoRefreshEnabled = false;
let currentModalCurrency = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize DOM-dependent variables
    allRows = Array.from(document.querySelectorAll('.arbitrage-row'));
    filteredRows = [...allRows];
    
    // Initialize all functionality
    initializeFilters();
    initializePagination();
    initializeExport();
    updateDisplay();
    
    function initializeFilters() {
         // Search functionality
         document.getElementById('searchCurrency').addEventListener('input', function() {
             applyFilters();
         });
         
         // Filter dropdowns
         document.getElementById('filterOpportunities').addEventListener('change', applyFilters);
         document.getElementById('sortBy').addEventListener('change', applyFilters);
         document.getElementById('spreadFilter').addEventListener('change', applyFilters);
         document.getElementById('rowsPerPage').addEventListener('change', function() {
             rowsPerPage = this.value === 'all' ? filteredRows.length : parseInt(this.value);
             currentPage = 1;
             updateDisplay();
         });
         
         // Clear filters
         document.getElementById('clearFilters').addEventListener('click', function() {
             document.getElementById('searchCurrency').value = '';
             document.getElementById('filterOpportunities').value = 'all';
             document.getElementById('sortBy').value = 'spread_desc';
             document.getElementById('spreadFilter').value = 'all';
             applyFilters();
         });
         
         // Refresh data
         document.getElementById('refreshData').addEventListener('click', function() {
             refreshArbitrageData();
         });
         
         // Column visibility controls
         document.querySelectorAll('.column-toggle').forEach(checkbox => {
             checkbox.addEventListener('change', function() {
                 toggleColumn(parseInt(this.dataset.column), this.checked);
             });
         });
         
         // Add table header click sorting
         document.querySelectorAll('#arbitrageTable th').forEach((header, index) => {
             if (index === 0 || index === 4 || index === 8) { // Currency, Spread %, Confidence
                 header.style.cursor = 'pointer';
                 header.innerHTML += ' <i class="fas fa-sort text-muted"></i>';
                 header.addEventListener('click', function() {
                     handleHeaderSort(index);
                 });
             }
         });
     }
     
     function applyFilters() {
         const searchTerm = document.getElementById('searchCurrency').value.toLowerCase();
         const opportunityFilter = document.getElementById('filterOpportunities').value;
         const sortBy = document.getElementById('sortBy').value;
         const spreadFilter = document.getElementById('spreadFilter').value;
         
         // Filter rows
         filteredRows = allRows.filter(row => {
             const currencyName = row.querySelector('td:first-child strong').textContent.toLowerCase();
             const isProfitable = row.dataset.profitable === 'true';
             const confidence = parseInt(row.dataset.confidence) || 0;
             const isLowConfidence = row.querySelector('.badge').textContent.trim() === '0' || confidence < 20;
             const spreadPercentage = parseFloat(row.cells[4].textContent.replace('%', '')) || 0;
             
             // Search filter
             if (searchTerm && !currencyName.includes(searchTerm)) return false;
             
             // Opportunity filter
             switch(opportunityFilter) {
                 case 'profitable': if (!isProfitable) return false; break;
                 case 'high-confidence': if (confidence < 50) return false; break;
                 case 'low-confidence': if (!isLowConfidence) return false; break;
             }
             
             // Spread filter
             switch(spreadFilter) {
                 case 'high': if (spreadPercentage <= 5) return false; break;
                 case 'medium': if (spreadPercentage <= 1 || spreadPercentage > 5) return false; break;
                 case 'low': if (spreadPercentage > 1) return false; break;
             }
             
             return true;
         });
         
         // Sort rows
         filteredRows.sort((a, b) => {
             switch(sortBy) {
                 case 'spread_desc':
                     return parseFloat(b.cells[4].textContent) - parseFloat(a.cells[4].textContent);
                 case 'spread_asc':
                     return parseFloat(a.cells[4].textContent) - parseFloat(b.cells[4].textContent);
                 case 'confidence_desc':
                     return parseInt(b.dataset.confidence) - parseInt(a.dataset.confidence);
                 case 'confidence_asc':
                     return parseInt(a.dataset.confidence) - parseInt(b.dataset.confidence);
                 case 'name_asc':
                     return a.querySelector('td:first-child strong').textContent.localeCompare(
                         b.querySelector('td:first-child strong').textContent);
                 default:
                     return 0;
             }
         });
         
         currentPage = 1;
         updateDisplay();
         updateQuickStats();
     }
     
     function initializePagination() {
         // Pagination will be handled in updateDisplay
     }
     
     function updateDisplay() {
         // Hide all rows first
         allRows.forEach(row => row.style.display = 'none');
         
         // Calculate pagination
         const totalRows = filteredRows.length;
         const totalPages = rowsPerPage === 'all' ? 1 : Math.ceil(totalRows / rowsPerPage);
         const startIndex = rowsPerPage === 'all' ? 0 : (currentPage - 1) * rowsPerPage;
         const endIndex = rowsPerPage === 'all' ? totalRows : Math.min(startIndex + rowsPerPage, totalRows);
         
         // Show current page rows
         for (let i = startIndex; i < endIndex; i++) {
             if (filteredRows[i]) {
                 filteredRows[i].style.display = '';
             }
         }
         
         // Update results info
         document.getElementById('resultsInfo').textContent = 
             `Showing ${startIndex + 1}-${endIndex} of ${totalRows} results`;
         
         // Update pagination
         updatePagination(totalPages);
     }
     
     function updatePagination(totalPages) {
         const pagination = document.getElementById('pagination');
         pagination.innerHTML = '';
         
         if (totalPages <= 1) return;
         
         // Previous button
         const prevLi = document.createElement('li');
         prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
         prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
         pagination.appendChild(prevLi);
         
         // Page numbers
         const startPage = Math.max(1, currentPage - 2);
         const endPage = Math.min(totalPages, currentPage + 2);
         
         for (let i = startPage; i <= endPage; i++) {
             const li = document.createElement('li');
             li.className = `page-item ${i === currentPage ? 'active' : ''}`;
             li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
             pagination.appendChild(li);
         }
         
         // Next button
         const nextLi = document.createElement('li');
         nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
         nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
         pagination.appendChild(nextLi);
         
         // Add click handlers
         pagination.addEventListener('click', function(e) {
             e.preventDefault();
             if (e.target.tagName === 'A' && !e.target.parentElement.classList.contains('disabled')) {
                 currentPage = parseInt(e.target.dataset.page);
                 updateDisplay();
             }
         });
     }
     
     function initializeExport() {
         document.getElementById('exportData').addEventListener('click', function() {
             exportToCSV();
         });
     }
     
     function exportToCSV() {
          const headers = ['Currency', 'Buy Price', 'Sell Price', 'Spread', 'Spread %', 'Listing Diff', 'Pay Listings', 'Receive Listings', 'Confidence', 'Opportunity'];
          const csvContent = [headers.join(',')];
          
          filteredRows.forEach(row => {
              const cells = Array.from(row.cells).slice(0, -1); // Exclude last updated column
              const rowData = cells.map(cell => {
                  let text = cell.textContent.trim();
                  // Clean up text and escape commas
                  text = text.replace(/\s+/g, ' ').replace(/"/g, '""');
                  return `"${text}"`;
              });
              csvContent.push(rowData.join(','));
          });
          
          const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `arbitrage_opportunities_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
      }
      
      function toggleColumn(columnIndex, show) {
          const table = document.getElementById('arbitrageTable');
          const headerCell = table.querySelector(`thead tr th:nth-child(${columnIndex + 1})`);
          const bodyCells = table.querySelectorAll(`tbody tr td:nth-child(${columnIndex + 1})`);
          
          if (headerCell) {
              headerCell.style.display = show ? '' : 'none';
          }
          bodyCells.forEach(cell => {
              cell.style.display = show ? '' : 'none';
          });
      }
      
      let currentSortColumn = null;
      let currentSortDirection = 'desc';
      
      function handleHeaderSort(columnIndex) {
          // Update sort direction
          if (currentSortColumn === columnIndex) {
              currentSortDirection = currentSortDirection === 'desc' ? 'asc' : 'desc';
          } else {
              currentSortDirection = 'desc';
          }
          currentSortColumn = columnIndex;
          
          // Update sort dropdown to match
          const sortSelect = document.getElementById('sortBy');
          switch(columnIndex) {
              case 0: // Currency
                  sortSelect.value = 'name_asc';
                  break;
              case 4: // Spread %
                  sortSelect.value = currentSortDirection === 'desc' ? 'spread_desc' : 'spread_asc';
                  break;
              case 8: // Confidence
                  sortSelect.value = currentSortDirection === 'desc' ? 'confidence_desc' : 'confidence_asc';
                  break;
          }
          
          // Update header icons
          document.querySelectorAll('#arbitrageTable th i.fa-sort, #arbitrageTable th i.fa-sort-up, #arbitrageTable th i.fa-sort-down')
              .forEach(icon => {
                  icon.className = 'fas fa-sort text-muted';
              });
          
          const currentHeader = document.querySelector(`#arbitrageTable th:nth-child(${columnIndex + 1}) i`);
          if (currentHeader) {
              currentHeader.className = `fas fa-sort-${currentSortDirection === 'desc' ? 'down' : 'up'} text-info`;
          }
          
          applyFilters();
      }
     
     // Load arbitrage chart data
     fetch(`/api/arbitrage-chart?league={{ league }}`)
         .then(response => response.json())
         .then(data => {
             createArbitrageChart(data);
             createConfidenceChart(data);
         })
         .catch(error => {
             console.error('Error loading arbitrage chart data:', error);
         });
     
     // Initialize quick stats
      updateQuickStats();
      
      // Apply visual enhancements
      applyVisualEnhancements();
      
      // Add currency link event listeners
      initializeCurrencyLinks();
  });
  
  function initializeCurrencyLinks() {
      document.querySelectorAll('.currency-link').forEach(link => {
          link.addEventListener('click', function(e) {
              e.preventDefault();
              const currency = this.dataset.currency;
              const buyPrice = parseFloat(this.dataset.buyPrice) || 0;
              const sellPrice = parseFloat(this.dataset.sellPrice) || 0;
              const spread = parseFloat(this.dataset.spread) || 0;
              const confidence = parseInt(this.dataset.confidence) || 0;
              const payListings = parseInt(this.dataset.payListings) || 0;
              const receiveListings = parseInt(this.dataset.receiveListings) || 0;
              const lastUpdated = this.dataset.lastUpdated || '';
              
              showCurrencyModal(currency, buyPrice, sellPrice, spread, confidence, payListings, receiveListings, lastUpdated);
          });
      });
  }
  
  function applyVisualEnhancements() {
      const rows = document.querySelectorAll('.arbitrage-row');
      
      rows.forEach(row => {
          // Color code spread percentages
          const spreadCell = row.cells[4];
          const spreadText = spreadCell.textContent.replace('%', '');
          const spread = parseFloat(spreadText) || 0;
          
          if (spread >= 20) {
              spreadCell.classList.add('spread-excellent');
          } else if (spread >= 15) {
              spreadCell.classList.add('spread-high');
          } else if (spread >= 10) {
              spreadCell.classList.add('spread-good');
          } else {
              spreadCell.classList.add('spread-low');
          }
          
          // Color code confidence levels
          const confidenceCell = row.cells[8];
          const confidence = parseInt(row.dataset.confidence) || 0;
          
          if (confidence >= 70) {
              confidenceCell.classList.add('confidence-high');
          } else if (confidence >= 40) {
              confidenceCell.classList.add('confidence-medium');
          } else {
              confidenceCell.classList.add('confidence-low');
          }
      });
  }

function calculateProfit() {
    const investment = parseFloat(document.getElementById('investmentAmount').value) || 0;
    const spread = parseFloat(document.getElementById('spreadPercentage').value) || 0;
    
    if (investment <= 0 || spread <= 0) {
        document.getElementById('profitAmount').textContent = '-';
        document.getElementById('totalReturn').textContent = '-';
        document.getElementById('roiPercentage').textContent = '-';
        return;
    }
    
    const profit = investment * (spread / 100);
    const totalReturn = investment + profit;
    
    document.getElementById('profitAmount').textContent = `${profit.toFixed(2)} Chaos`;
    document.getElementById('totalReturn').textContent = `${totalReturn.toFixed(2)} Chaos`;
    document.getElementById('roiPercentage').textContent = `${spread.toFixed(2)}%`;
}

function updateQuickStats() {
    const rows = document.querySelectorAll('.arbitrage-row');
    let totalSpread = 0;
    let maxSpread = 0;
    let highConfCount = 0;
    let totalOpps = 0;
    
    rows.forEach(row => {
        const spreadText = row.cells[4].textContent.replace('%', '');
        const spread = parseFloat(spreadText) || 0;
        const confidence = parseInt(row.dataset.confidence) || 0;
        const isProfitable = row.dataset.profitable === 'true';
        
        totalSpread += spread;
        maxSpread = Math.max(maxSpread, spread);
        
        if (confidence >= 50) highConfCount++;
        if (isProfitable) totalOpps++;
    });
    
    const avgSpread = rows.length > 0 ? totalSpread / rows.length : 0;
    
    document.getElementById('avgSpread').textContent = `${avgSpread.toFixed(2)}%`;
    document.getElementById('topSpread').textContent = `${maxSpread.toFixed(2)}%`;
    document.getElementById('highConfCount').textContent = highConfCount;
    document.getElementById('totalOpps').textContent = totalOpps;
}

function createArbitrageChart(data) {
    const ctx = document.getElementById('arbitrageChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.slice(0, 10).map(item => item.currency_name),
            datasets: [{
                label: 'Spread Percentage',
                data: data.slice(0, 10).map(item => item.spread_percentage),
                backgroundColor: 'rgba(79, 209, 199, 0.8)',
                borderColor: 'rgba(79, 209, 199, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e8e8e8'
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#e8e8e8',
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e8e8e8',
                        maxRotation: 45
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

function createConfidenceChart(data) {
    const ctx = document.getElementById('confidenceChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Arbitrage Opportunities',
                data: data.map(item => ({
                    x: item.confidence_score,
                    y: item.spread_percentage
                })),
                backgroundColor: 'rgba(79, 209, 199, 0.6)',
                borderColor: 'rgba(79, 209, 199, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e8e8e8'
                    }
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const dataIndex = context[0].dataIndex;
                            return data[dataIndex].currency_name;
                        },
                        label: function(context) {
                            return [
                                `Confidence: ${context.parsed.x}`,
                                `Spread: ${context.parsed.y.toFixed(2)}%`
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Spread Percentage (%)',
                        color: '#e8e8e8'
                    },
                    ticks: {
                        color: '#e8e8e8'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Confidence Score',
                        color: '#e8e8e8'
                    },
                    ticks: {
                        color: '#e8e8e8'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
}

// Auto-refresh functionality
function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    const icon = document.getElementById('refreshIcon');
    
    if (isAutoRefreshEnabled) {
        // Disable auto-refresh
        clearInterval(autoRefreshInterval);
        isAutoRefreshEnabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt" id="refreshIcon"></i> Auto Refresh: OFF';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-success');
    } else {
        // Enable auto-refresh
        const intervalSeconds = parseInt(document.getElementById('refreshInterval').value);
        startAutoRefresh(intervalSeconds);
        isAutoRefreshEnabled = true;
        btn.innerHTML = '<i class="fas fa-sync-alt fa-spin" id="refreshIcon"></i> Auto Refresh: ON';
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-success');
    }
}

function startAutoRefresh(intervalSeconds) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(() => {
        refreshArbitrageData();
    }, intervalSeconds * 1000);
}

function refreshArbitrageData() {
    const refreshBtn = document.getElementById('refreshData');
    const originalText = refreshBtn.innerHTML;
    
    // Show loading state
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    refreshBtn.disabled = true;
    
    // Reload the page to get fresh data
    setTimeout(() => {
        location.reload();
    }, 500);
}

// Update auto-refresh interval when dropdown changes
document.getElementById('refreshInterval').addEventListener('change', function() {
    if (isAutoRefreshEnabled) {
        const intervalSeconds = parseInt(this.value);
        startAutoRefresh(intervalSeconds);
    }
});

    // Clean up interval on page unload
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });

// Currency modal functionality
function showCurrencyModal(currencyName, buyPrice, sellPrice, spreadPercentage, confidenceScore, payListings, receiveListings, lastUpdated) {
    currentModalCurrency = currencyName;
    
    // Update modal content
    document.getElementById('modalCurrencyName').textContent = currencyName;
    document.getElementById('modalBuyPrice').textContent = buyPrice ? buyPrice.toFixed(4) : '-';
    document.getElementById('modalSellPrice').textContent = sellPrice ? sellPrice.toFixed(4) : '-';
    document.getElementById('modalSpreadPercentage').textContent = spreadPercentage ? spreadPercentage.toFixed(2) + '%' : '-';
    document.getElementById('modalConfidenceScore').textContent = confidenceScore || '0';
    document.getElementById('modalPayListings').textContent = payListings || '0';
    document.getElementById('modalReceiveListings').textContent = receiveListings || '0';
    document.getElementById('modalLastUpdated').textContent = lastUpdated ? lastUpdated.substring(0, 19) : 'N/A';
    
    // Set confidence score color
    const confidenceElement = document.getElementById('modalConfidenceScore');
    if (confidenceScore >= 50) {
        confidenceElement.className = 'h5 text-success';
    } else if (confidenceScore >= 20) {
        confidenceElement.className = 'h5 text-warning';
    } else {
        confidenceElement.className = 'h5 text-danger';
    }
    
    // Set spread percentage color
    const spreadElement = document.getElementById('modalSpreadPercentage');
    if (spreadPercentage >= 10) {
        spreadElement.className = 'h4 text-success';
    } else if (spreadPercentage >= 5) {
        spreadElement.className = 'h4 text-warning';
    } else if (spreadPercentage > 0) {
        spreadElement.className = 'h4 text-info';
    } else {
        spreadElement.className = 'h4 text-danger';
    }
    
    // Reset calculator
    document.getElementById('modalInvestmentAmount').value = '';
    document.getElementById('modalPotentialProfit').textContent = '-';
    document.getElementById('modalTotalReturn').textContent = '-';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('currencyModal'));
    modal.show();
}

// Modal profit calculator
document.getElementById('modalInvestmentAmount').addEventListener('input', function() {
    const investment = parseFloat(this.value) || 0;
    const spreadText = document.getElementById('modalSpreadPercentage').textContent;
    const spread = parseFloat(spreadText.replace('%', '')) || 0;
    
    if (investment > 0 && spread > 0) {
        const profit = investment * (spread / 100);
        const totalReturn = investment + profit;
        
        document.getElementById('modalPotentialProfit').textContent = profit.toFixed(2) + ' Chaos';
        document.getElementById('modalTotalReturn').textContent = totalReturn.toFixed(2) + ' Chaos';
    } else {
        document.getElementById('modalPotentialProfit').textContent = '-';
        document.getElementById('modalTotalReturn').textContent = '-';
    }
});

function openPoeNinjaLink() {
    if (currentModalCurrency) {
        const league = '{{ league }}' || 'mercenaries';
        const encodedCurrencyName = encodeURIComponent(currentModalCurrency);
        const url = `https://poe.ninja/economy/${league}/currency?name=${encodedCurrencyName}`;
        window.open(url, '_blank');
    }
}
</script>
{% endblock %}